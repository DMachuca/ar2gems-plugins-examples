; getting variables from CMAKE
!define INSTALLER_OUTFILE_NAME "@CPACK_NSIS_INSTALLER_OUTFILE_NAME@"
!define PLUGIN_BINARY_DIR "@CPACK_NSIS_AR2GEMS_PLUGIN_BINARY_DIR@"
; getting variables from CMAKE

Name ${INSTALLER_OUTFILE_NAME}

!define SUBDIR_PLUGIN "\plugins\${INSTALLER_OUTFILE_NAME}"
!define SUBDIR_GEOST "\plugins\Geostat"
    
# General Symbol Definitions
!define REGKEY "SOFTWARE\$(^Name)"

; include for some of the windows messages defines
!include "winmessages.nsh"
; HKLM (all users) vs HKCU (current user) defines
!define env_hklm 'HKU  "SYSTEM\CurrentControlSet\Control\Session Manager\Environment"'
!define env_hkcu 'HKCU "Environment"'
;!define GSTLAPPLIHOME "GSTLAPPLIHOME"


# MUI Symbol Definitions
;!define MUI_ICON "${AR2GEMS_SOURCE_DIR}\WinGsTLAppli\main\ar2gems_icon_256x256.ico"
!define MUI_FINISHPAGE_NOAUTOCLOSE
!define MUI_UNFINISHPAGE_NOAUTOCLOSE

# Included files
!include Sections.nsh
!include MUI2.nsh


# Variables
Var StartMenuGroup

# Installer pages
!insertmacro MUI_PAGE_WELCOME
;!insertmacro MUI_PAGE_LICENSE ${AR2GEMS_SOURCE_DIR}\LICENSE-ar2tech.txt
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES

# Installer languages
!insertmacro MUI_LANGUAGE English
!insertmacro MUI_LANGUAGE French
!insertmacro MUI_LANGUAGE Italian
!insertmacro MUI_LANGUAGE German

# Installer attributes
OutFile ${INSTALLER_OUTFILE_NAME}.exe
InstallDirRegKey HKLM "SOFTWARE\Wow6432Node\SGeMS-ar2Tech-beta-x64" "Path"
CRCCheck on
XPStyle on
ShowInstDetails hide
VIProductVersion 2.5.0.0
VIAddVersionKey /LANG=${LANG_ENGLISH} ProductName SGeMS-beta
VIAddVersionKey /LANG=${LANG_ENGLISH} ProductVersion "${VERSION}"
VIAddVersionKey /LANG=${LANG_ENGLISH} CompanyWebsite "${URL}"
VIAddVersionKey /LANG=${LANG_ENGLISH} FileVersion "${VERSION}"
VIAddVersionKey /LANG=${LANG_ENGLISH} FileDescription ""
VIAddVersionKey /LANG=${LANG_ENGLISH} LegalCopyright ""
;InstallDirRegKey HKLM "${REGKEY}" Path
ShowUninstDetails hide

# Installer sections
Section "Main" SEC0000
    SetOverwrite on

    SetOutPath $INSTDIR${SUBDIR_PLUGIN}     
    File ${PLUGIN_BINARY_DIR}\${INSTALLER_OUTFILE_NAME}\*.dll
    SetOutPath $INSTDIR${SUBDIR_GEOST} 
    File /nonfatal ${PLUGIN_BINARY_DIR}\Geostat\*.dll
        
    ;WriteRegStr HKLM "${REGKEY}\Components" Main 1
SectionEnd

Section "post" SEC0001


    WriteRegStr HKLM "${REGKEY}" Path $INSTDIR
    
    ;WriteRegExpandStr ${env_hkcu} VTK_AUTOLOAD_PATH $INSTDIR
    ;WriteRegExpandStr ${env_hkcu} GSTLAPPLIHOME $INSTDIR
   ; make sure windows knows about the change
    SendMessage ${HWND_BROADCAST} ${WM_WININICHANGE} 0 "STR:Environment" /TIMEOUT=5000    
    WriteUninstaller $INSTDIR\${SUBDIR_PLUGIN}\uninstall.exe
    SetOutPath $SMPROGRAMS\$StartMenuGroup
    SetOutPath $INSTDIR
    ;CreateShortcut "$SMPROGRAMS\$StartMenuGroup\$(^UninstallLink).lnk" $INSTDIR\uninstall.exe
    ;CreateShortcut "$SMPROGRAMS\$StartMenuGroup\$(^Name).lnk" "$INSTDIR\sgems-x64.exe" "" "$INSTDIR\ar2gems_icon_256_256.ico"
    ;CreateShortcut "$DESKTOP\$(^Name).lnk" "$INSTDIR\sgems-x64.exe" "" "$INSTDIR\ar2gems_icon_256_256.ico"
    WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" DisplayName "$(^Name)"
    ;WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" DisplayVersion "${VERSION}"
    ;WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" URLInfoAbout "${URL}"
    WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" DisplayIcon $INSTDIR\{SUBDIR_PLUGIN}\uninstall.exe
    WriteRegStr HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" UninstallString $INSTDIR\${SUBDIR_PLUGIN}\uninstall.exe
    WriteRegDWORD HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" NoModify 1
    WriteRegDWORD HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)" NoRepair 1
SectionEnd

# Macro for selecting uninstaller sections
!macro SELECT_UNSECTION SECTION_NAME UNSECTION_ID
    Push $R0
    ReadRegStr $R0 HKLM "${REGKEY}\Components" "${SECTION_NAME}"
    StrCmp $R0 1 0 next${UNSECTION_ID}
    !insertmacro SelectSection "${UNSECTION_ID}"
    GoTo done${UNSECTION_ID}
next${UNSECTION_ID}:
    !insertmacro UnselectSection "${UNSECTION_ID}"
done${UNSECTION_ID}:
    Pop $R0
!macroend





# Uninstaller sections
Section /o "un.Main" UNSEC0000
    DeleteRegValue HKLM "${REGKEY}\Components" Main
SectionEnd

Section "un.post" UNSEC0001
    DeleteRegKey HKLM "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\$(^Name)"
    DeleteRegValue ${env_hklm} GSTLAPPLIHOME

    Delete $INSTDIR\${SUBDIR_PLUGIN}\*.dll
    Delete $INSTDIR\${SUBDIR_GEOST}\*.dll
            
    Delete  $INSTDIR\${SUBDIR_PLUGIN}\uninstall.exe
    
    DeleteRegValue HKLM "${REGKEY}" Path
    DeleteRegKey /IfEmpty HKLM "${REGKEY}\Components"
    DeleteRegKey /IfEmpty HKLM "${REGKEY}"
    RmDir /REBOOTOK $SMPROGRAMS\$StartMenuGroup
    RmDir /REBOOTOK $INSTDIR/${SUBDIR_PLUGIN} ;
SectionEnd




# Installer functions
Function .onInit
    InitPluginsDir
    StrCpy $StartMenuGroup $(^Name)
    Push $R1
    ;File /oname=$PLUGINSDIR\spltmp.bmp ${AR2GEMS_SOURCE_DIR}\WinGsTLAppli\main\ar2gems_splash.bmp
    ;advsplash::show 1000 600 400 -1 $PLUGINSDIR\spltmp
    Pop $R1
    Pop $R1
FunctionEnd

# Uninstaller functions
Function un.onInit
    ReadRegStr $INSTDIR HKLM "${REGKEY}" Path
    StrCpy $StartMenuGroup $(^Name)
    !insertmacro SELECT_UNSECTION Main ${UNSEC0000}
FunctionEnd

# Installer Language Strings
# TODO Update the Language Strings with the appropriate translations.

LangString ^UninstallLink ${LANG_ENGLISH} "Uninstall $(^Name)"
LangString ^UninstallLink ${LANG_FRENCH} "Uninstall $(^Name)"
LangString ^UninstallLink ${LANG_ITALIAN} "Uninstall $(^Name)"
LangString ^UninstallLink ${LANG_GERMAN} "Uninstall $(^Name)"



